name: æ´›è°·+æ˜é‡‘è‡ªåŠ¨æ‰“å¡ (å«é‚®ä»¶æ—¥æŠ¥)

on:
  # 1. å®šæ—¶è§¦å‘
  schedule:
    # åŒ—äº¬æ—¶é—´ 08:00
    - cron: '0 0 * * *'
    # åŒ—äº¬æ—¶é—´ 20:00 (è¡¥ç­¾)
    - cron: '0 12 * * *'
  # 2. å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  punch:
    runs-on: ubuntu-latest
    
    steps:
    # ç¬¬ä¸€æ­¥ï¼šä¸‹è½½ä»£ç 
    - name: Checkout Code
      uses: actions/checkout@v3

    # ç¬¬äºŒæ­¥ï¼šå®‰è£… Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ä¾èµ– (ä¿ç•™äº† Playwrightï¼Œä¸ºäº†æ˜é‡‘)
    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        playwright install chromium

    # ç¬¬å››æ­¥ï¼šæ ¸å¿ƒèåˆ (è¿è¡Œæ‰€æœ‰è„šæœ¬ + æ•è·æ—¥å¿—)
    - name: Run Scripts & Capture Log
      id: punch-script
      env:
        # æ³¨å…¥æ‰€æœ‰çš„ Token/Cookie
        LUOGU_COOKIE: ${{ secrets.LUOGU_COOKIE }}
        JUEJIN_COOKIE: ${{ secrets.JUEJIN_COOKIE }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
      run: |
        # ä½¿ç”¨ { ... } åŒ…è£¹ï¼Œå°†å†…éƒ¨æ‰€æœ‰è¾“å‡ºåˆå¹¶å¤„ç†
        {
          echo "==============================================="
          echo "ğŸš€ 1. å¼€å§‹æ‰§è¡Œ æ´›è°·æ‰“å¡ (main.py)"
          echo "==============================================="
          # || echo é˜²æ­¢æ´›è°·æŠ¥é”™å¯¼è‡´æ˜é‡‘ä¸è·‘
          python main.py || echo "âŒ æ´›è°·è„šæœ¬æ‰§è¡Œå¼‚å¸¸"

          # å¦‚æœä¸éœ€è¦æ˜é‡‘æ‰“å¡è¯·åˆ é™¤ä»¥ä¸‹å†…å®¹ã€‚
          
          echo -e "\n\n"
          echo "==============================================="
          echo "ğŸš€ 2. å¼€å§‹æ‰§è¡Œ æ˜é‡‘æ‰“å¡ (juejin.py)"
          echo "==============================================="
          python juejin.py || echo "âŒ æ˜é‡‘è„šæœ¬æ‰§è¡Œå¼‚å¸¸"
          
        } 2>&1 | tee log.txt
        # 2>&1 | tee log.txt çš„æ„æ€æ˜¯ï¼šæŠŠå±å¹•ä¸Šæ˜¾ç¤ºçš„å­—ï¼ŒåŒæ—¶ä¿å­˜ä¸€ä»½åˆ° log.txt

    # ç¬¬äº”æ­¥ï¼šè¯»å–æ—¥å¿—å†…å®¹ (ä¸ºå‘é‚®ä»¶åšå‡†å¤‡)
    - name: Read log content
      id: read_log
      if: always() # å³ä½¿è„šæœ¬æŠ¥é”™ï¼Œä¹Ÿè¦æ‰§è¡Œè¿™æ­¥
      run: |
        if [ -f "log.txt" ]; then
          # è¯»å–æ—¥å¿—å‰ 50000 ä¸ªå­—ç¬¦
          LOG_CONTENT=$(cat log.txt | head -c 50000)
          # å†™å…¥è¾“å‡ºå˜é‡
          echo "log_content<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "log_exists=true" >> $GITHUB_OUTPUT
        else
          echo "log_content=æ—¥å¿—æ–‡ä»¶æœªç”Ÿæˆ" >> $GITHUB_OUTPUT
          echo "log_exists=false" >> $GITHUB_OUTPUT
        fi

    # ç¬¬å…­æ­¥ï¼šä¸Šä¼ æ—¥å¿—æ–‡ä»¶ (æ–¹ä¾¿åœ¨ GitHub ç½‘é¡µä¸‹è½½)
    - name: Upload log file
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: punch-log
        path: log.txt
        retention-days: 7
    
    # è¡¥å……ï¼šæ—¶é—´è·å–ã€‚
    - name: Get Current Date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    # ç¬¬ä¸ƒæ­¥ï¼šå‘é€é‚®ä»¶ (æ•´åˆäº† PR çš„åŠŸèƒ½ï¼Œæ„Ÿè°¢è´¡çŒ®)
    - name: Send Email
      if: steps.read_log.outputs.log_exists == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        # ğŸ‘‡ 1. ä¿®æ”¹é‚®ä»¶æœåŠ¡å™¨ (QQé‚®ç®±ç”¨ smtp.qq.com)
        server_address: smtp.163.com
        server_port: 465
        
        # ğŸ‘‡ 2. ç¡®ä¿ Secrets é‡Œé…å¥½äº†è¿™ä¸¤ä¸ª
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        
        subject: 'æ¯æ—¥æ‰“å¡æ—¥æŠ¥ - ${{ github.repository }}'
        
        # é‚®ä»¶æ­£æ–‡ï¼šç›´æ¥æ˜¾ç¤ºåˆšæ‰æ•è·çš„æ—¥å¿—
        body: |
          è‡ªåŠ¨æ‰“å¡ä»»åŠ¡æ‰§è¡ŒæŠ¥å‘Š
          
          è¿è¡Œæ—¶é—´: ${{ steps.date.outputs.date }}
          
          è¯¦ç»†æ—¥å¿—ï¼š
          --------------------------------------------------
          ${{ steps.read_log.outputs.log_content }}
          --------------------------------------------------
          
          (æœ¬é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€)
        
        # ğŸ‘‡ 3. ä¿®æ”¹æ”¶ä»¶äºº (æ”¹æˆä½ è‡ªå·±çš„ï¼)
        to: sa101333@163.com # è¯·å°†æ­¤å¤„æ”¹æˆä½ è‡ªå·±çš„é‚®ç®±ã€‚
        from: æ‰“å¡åŠ©æ‰‹ <${{ secrets.EMAIL_USERNAME }}>
        content_type: text/plain
